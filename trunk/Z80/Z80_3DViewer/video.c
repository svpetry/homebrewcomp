#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "video.h"
#include "defs.h"
#include "utils.h"

// text mode -------------------------------------------------------------------

static volatile byte __at VIDEO_BUFFER linebuf[V_ROWS][V_COLS];
static volatile byte line_ptr = 0;

// graphic mode ----------------------------------------------------------------

char vbuf[0x0c80];

const byte num[10][5 * 7] =
{
	{
		0, 1, 1, 1, 0,  // 0, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 1, 1, 
		1, 0, 1, 0, 1, 
		1, 1, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0
	}, {
		0, 0, 1, 0, 0,  // 1, 
		0, 1, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 1, 1, 1, 0
	}, {
		0, 1, 1, 1, 0,  // 2
		1, 0, 0, 0, 1, 
		0, 0, 0, 0, 1, 
		0, 0, 0, 1, 0, 
		0, 0, 1, 0, 0, 
		0, 1, 0, 0, 0, 
		1, 1, 1, 1, 1
	}, {
		1, 1, 1, 1, 1,  // 3
		0, 0, 0, 1, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 0, 1, 0, 
		0, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0
	}, {
		0, 0, 0, 1, 0,  // 4
		0, 0, 1, 1, 0, 
		0, 1, 0, 1, 0, 
		1, 0, 0, 1, 0, 
		1, 1, 1, 1, 1, 
		0, 0, 0, 1, 0, 
		0, 0, 0, 1, 0
	}, {
		1, 1, 1, 1, 1,  // 5
		1, 0, 0, 0, 0, 
		1, 1, 1, 1, 0, 
		0, 0, 0, 0, 1, 
		0, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0
	}, {
		0, 0, 1, 1, 0,  // 6
		0, 1, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 1, 1, 1, 0, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0
	}, {
		1, 1, 1, 1, 1,  // 7
		0, 0, 0, 0, 1, 
		0, 0, 0, 1, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0
	}, {
		0, 1, 1, 1, 0,  // 8
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0
	}, {
		0, 1, 1, 1, 0,  // 9
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 1, 
		0, 0, 0, 0, 1, 
		0, 0, 0, 1, 0, 
		0, 1, 1, 0, 0
	}
};

const byte alpha[26][5 * 7] =
{
	{
		0, 1, 1, 1, 0,  // A
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 1, 1, 1, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1 
	}, {
		1, 1, 1, 1, 0,  // B
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 1, 1, 1, 0, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 1, 1, 1, 0
	}, {
		0, 1, 1, 1, 0,  // C
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0 
	}, {
		1, 1, 1, 0, 0,  // D
		1, 0, 0, 1, 0, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 1, 0, 
		1, 1, 1, 0, 0 
	}, {
		1, 1, 1, 1, 1,  // E
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 1, 1, 1, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 1, 1, 1, 1 
	}, {
		1, 1, 1, 1, 1,  // F
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 1, 1, 1, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0 
	}, {
		0, 1, 1, 1, 0,  // G
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 0, 
		1, 0, 1, 1, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 1 
	}, {
		1, 0, 0, 0, 1,  // H
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 1, 1, 1, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1 
	}, {
		0, 1, 1, 1, 0,  // I
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 1, 1, 1, 0 
	}, {
		0, 0, 1, 1, 1,  // J
		0, 0, 0, 1, 0, 
		0, 0, 0, 1, 0, 
		0, 0, 0, 1, 0, 
		0, 0, 0, 1, 0, 
		1, 0, 0, 1, 0, 
		0, 1, 1, 0, 0 
	}, {
		1, 0, 0, 0, 1,  // K
		1, 0, 0, 1, 0, 
		1, 0, 1, 0, 0, 
		1, 1, 0, 0, 0, 
		1, 0, 1, 0, 0, 
		1, 0, 0, 1, 0, 
		1, 0, 0, 0, 1 
	}, {
		1, 0, 0, 0, 0,  // L
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 1, 1, 1, 1 
	}, {
		1, 0, 0, 0, 1,  // M
		1, 1, 0, 1, 1, 
		1, 0, 1, 0, 1, 
		1, 0, 1, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1 
	}, {
		1, 0, 0, 0, 1,  // N
		1, 0, 0, 0, 1, 
		1, 1, 0, 0, 1, 
		1, 0, 1, 0, 1, 
		1, 0, 0, 1, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1 
	}, {
		0, 1, 1, 1, 0,  // O
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0 
	}, {
		1, 1, 1, 1, 0,  // P
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 1, 1, 1, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0 
	}, {
		0, 1, 1, 1, 0,  // Q
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 1, 0, 1, 
		1, 0, 0, 1, 0, 
		0, 1, 1, 0, 1 
	}, {
		1, 1, 1, 1, 0,  // R
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 1, 1, 1, 0, 
		1, 0, 1, 0, 0, 
		1, 0, 0, 1, 0, 
		1, 0, 0, 0, 1 
	}, {
		0, 1, 1, 1, 1,  // S
		1, 0, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		0, 1, 1, 1, 0, 
		0, 0, 0, 0, 1, 
		0, 0, 0, 0, 1, 
		1, 1, 1, 1, 0 
	}, {
		1, 1, 1, 1, 1,  // T
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0 
	}, {
		1, 0, 0, 0, 1,  // U
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 1, 1, 0 
	}, {
		1, 0, 0, 0, 1,  // V
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		0, 1, 0, 1, 0, 
		0, 0, 1, 0, 0 
	}, {
		1, 0, 0, 0, 1,  // W
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1, 
		1, 0, 1, 0, 1, 
		1, 0, 1, 0, 1, 
		1, 1, 0, 1, 1, 
		1, 0, 0, 0, 1 
	}, {
		1, 0, 0, 0, 1,  // X
		1, 0, 0, 0, 1, 
		0, 1, 0, 1, 0, 
		0, 0, 1, 0, 0, 
		0, 1, 0, 1, 0, 
		1, 0, 0, 0, 1, 
		1, 0, 0, 0, 1 
	}, {
		1, 0, 0, 0, 1,  // Y
		1, 0, 0, 0, 1, 
		0, 1, 0, 1, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0, 
		0, 0, 1, 0, 0 
	}, {
		1, 1, 1, 1, 1,  // Z
		0, 0, 0, 0, 1, 
		0, 0, 0, 1, 0, 
		0, 0, 1, 0, 0, 
		0, 1, 0, 0, 0, 
		1, 0, 0, 0, 0, 
		1, 1, 1, 1, 1
	}
};

// text mode -------------------------------------------------------------------
/******************************************************************************/
void v_hidecursor() {
	byte lidx;
	byte *p;

	lidx = line_ptr + cur_row;
	if (lidx >= V_ROWS)
		lidx -= V_ROWS;
	p = (byte *)VIDEO_RAM + (((word)cur_row) << 7) + cur_col;
	*p = linebuf[lidx][cur_col];
} // v_hidecursor
/******************************************************************************/
void v_showcursor() {
	byte lidx;
	byte *p;

	lidx = line_ptr + cur_row;
	if (lidx >= V_ROWS)
		lidx -= V_ROWS;
	p = (byte *)VIDEO_RAM + (((word)cur_row) << 7) + cur_col;
	*p = linebuf[lidx][cur_col] + 128;
} // v_showcursor
/******************************************************************************/
void v_cls() {
	register byte i;
	register char *dest;

	dest = (char *)VIDEO_RAM;
	for (i = 0; i < V_ROWS; i++) {
		memset(dest, ' ', V_COLS);
		dest += V_ROWSIZE;
	}
	memset(&linebuf[0][0], ' ', V_ROWS * V_COLS);
	line_ptr = 0;
	cur_col = 0;
	cur_row = 0;
} // v_cls
/******************************************************************************/
void v_scrollup() {
	byte i, lidx;

	memset(&linebuf[line_ptr][0], ' ', V_COLS);
	if (++line_ptr == V_ROWS)
		line_ptr = 0;

	lidx = line_ptr;
	for (i = 0; i < V_ROWS; i++) {
		memcpy((byte *)(VIDEO_RAM + (i << 7)), &linebuf[lidx][0], V_COLS);
		if (++lidx == V_ROWS)
			lidx = 0;
	}

	if (cur_row > 0)
		cur_row--;
} // v_scrollup
/******************************************************************************/
void v_backspace() {
	byte lidx;

	if (cur_col > 0) {
		cur_col--;

		V_SETCHAR(cur_col, cur_row, ' ');

		lidx = line_ptr + cur_row;
		if (lidx >= V_ROWS)
			lidx -= V_ROWS;
		linebuf[lidx][cur_col] = ' ';
	}
} // v_backspace
/******************************************************************************/
void putchar(char c) {
	byte lidx;

	if (c == '\n') {
		cur_col = 0;
		if (++cur_row == V_ROWS)
			v_scrollup();
	}
	else if (c == '\t') {
		cur_col++;
		while (cur_col & 3  > 0)
			cur_col++;
		if (cur_col >= V_COLS) {
			cur_col = 0;
			if (++cur_row == V_ROWS)
				v_scrollup();
		}
	}
	else {
		if (c == '\r')
			return;

		V_SETCHAR(cur_col, cur_row, c);

		lidx = line_ptr + cur_row;
		if (lidx >= V_ROWS)
			lidx -= V_ROWS;
		linebuf[lidx][cur_col] = c;

		cur_col++;
		if (cur_col == V_COLS) {
			cur_col = 0;
			if (++cur_row == V_ROWS)
				v_scrollup();
		}
	}
} // putchar
/******************************************************************************/
// graphic mode ----------------------------------------------------------------
/******************************************************************************/
void setpixel(byte x, byte y) {
	register char *p;
	p = vbuf + (x >> 1) + ((y & 0b11111100) << 5);
	*p = *p | (((x & 1) + 1) << ((y & 3) << 1));
}
/******************************************************************************/
void clearpixel(byte x, byte y) {
	register char *p;
	p = vbuf + (x >> 1) + ((y & 0b11111100) << 5);
	*p = *p & ~(((x & 1) + 1) << ((y & 3) << 1));
}
/******************************************************************************/
byte getpixel(byte x, byte y) {
	register char *p;
	p = vbuf + (x >> 1) + ((y & 0b11111100) << 5);
	return (*p & (((x & 1) + 1) << ((y & 3) << 1))) > 0;
}
/******************************************************************************/
void buf2screen() {
	register char *src;
	register char *dest;
	register byte i;

	src = vbuf;
	dest = (char *)0x1000;

	for (i = 0; i < 25; i++) {
		memcpy(dest, src, 80);
		dest += 128;
		src += 128;        
	}
}
/******************************************************************************/
void clrbuf() {
	register byte i;
	char *p;

	p = vbuf;
	for (i = 0; i < 25; i++) {
		memset(p, 0, 80);
		p += 0x80;
	}
}
/******************************************************************************/
void line(byte x0, byte y0, byte x1, byte y1) {
	int dy = y1 - y0;
	int dx = x1 - x0;
	char stepx, stepy;
	register char *p;

	if (dy < 0) { dy = -dy;  stepy = -1; } else { stepy = 1; }
	if (dx < 0) { dx = -dx;  stepx = -1; } else { stepx = 1; }
	dy <<= 1;                                                  // dy is now 2*dy
	dx <<= 1;                                                  // dx is now 2*dx

	SET_PIXEL(x0, y0);
	if (dx > dy) {
		register int fraction = dy - (dx >> 1);                // same as 2*dy - dx
		while (x0 != x1) {
			if (fraction >= 0) {
				y0 += stepy;
				fraction -= dx;                                // same as fraction -= 2*dx
			}
			x0 += stepx;
			fraction += dy;                                    // same as fraction -= 2*dy
			SET_PIXEL(x0, y0);
		}
	} else {
		register int fraction = dx - (dy >> 1);
		while (y0 != y1) {
			if (fraction >= 0) {
				x0 += stepx;
				fraction -= dy;
			}
			y0 += stepy;
			fraction += dx;
			SET_PIXEL(x0, y0);
		}
	}
}
/******************************************************************************/
void vputchar(byte x, byte y, char c) {
	byte *p;
	register byte rowx;
	register byte xc, yc;

	if (c >= '0' && c <= '9')
		p = &num[c - '0'][0];
	else if (c >= 'A' && c <= 'Z')
		p = &alpha[c - 'A'][0];
	else if (c == ' ') {
		for (yc = 0; yc < 7; yc++) {
			rowx = x;
			for (xc = 0; xc < 6; xc++) {
				clearpixel(rowx, y);
				rowx++;
			}
			y++;
		}
		return;
	} else
		return;

	for (yc = 0; yc < 7; yc++) {
		rowx = x;
		for (xc = 0; xc < 5; xc++) {
			if (*p) {
				setpixel(rowx, y);
			} else {
				clearpixel(rowx, y);
			}
			rowx++;
			p++;
		}
		y++;
	}
}
/******************************************************************************/
void vputs(byte x, byte y, char *s) {
	while (*s) {
		vputchar(x, y, *s);
		x += 6;
		s++;
	}
}
/******************************************************************************/

