 #include "utils3d.h"
#include "video.h"

#define DIV4096(val) ((val >= 0) ? val >> 12 : (val >> 12) | 0xfff000)
#define SINUS(angle) sintable[angle & 1023];
#define COSINUS(angle) sintable[(angle + 256) & 1023];

const int sintable[1024] = {
	0,
	25, 50, 75, 100, 125, 150, 175, 200, 226, 251,
	276, 301, 326, 351, 376, 401, 426, 451, 476, 501,
	526, 551, 575, 600, 625, 650, 675, 700, 724, 749,
	774, 798, 823, 848, 872, 897, 921, 946, 970, 995,
	1019, 1043, 1067, 1092, 1116, 1140, 1164, 1188, 1212, 1236,
	1260, 1284, 1308, 1332, 1355, 1379, 1403, 1426, 1450, 1473,
	1497, 1520, 1543, 1567, 1590, 1613, 1636, 1659, 1682, 1705,
	1728, 1750, 1773, 1796, 1818, 1841, 1863, 1885, 1908, 1930,
	1952, 1974, 1996, 2018, 2040, 2061, 2083, 2105, 2126, 2148,
	2169, 2190, 2212, 2233, 2254, 2275, 2295, 2316, 2337, 2357,
	2378, 2398, 2419, 2439, 2459, 2479, 2499, 2519, 2539, 2558,
	2578, 2597, 2617, 2636, 2655, 2674, 2693, 2712, 2731, 2750,
	2768, 2787, 2805, 2823, 2841, 2859, 2877, 2895, 2913, 2930,
	2948, 2965, 2983, 3000, 3017, 3034, 3051, 3067, 3084, 3100,
	3117, 3133, 3149, 3165, 3181, 3197, 3212, 3228, 3243, 3258,
	3274, 3289, 3304, 3318, 3333, 3348, 3362, 3376, 3390, 3404,
	3418, 3432, 3446, 3459, 3473, 3486, 3499, 3512, 3525, 3537,
	3550, 3563, 3575, 3587, 3599, 3611, 3623, 3634, 3646, 3657,
	3668, 3680, 3691, 3701, 3712, 3723, 3733, 3743, 3753, 3763,
	3773, 3783, 3792, 3802, 3811, 3820, 3829, 3838, 3847, 3855,
	3864, 3872, 3880, 3888, 3896, 3903, 3911, 3918, 3925, 3932,
	3939, 3946, 3953, 3959, 3966, 3972, 3978, 3984, 3989, 3995,
	4000, 4006, 4011, 4016, 4021, 4025, 4030, 4034, 4038, 4042,
	4046, 4050, 4054, 4057, 4061, 4064, 4067, 4070, 4072, 4075,
	4077, 4079, 4081, 4083, 4085, 4087, 4088, 4090, 4091, 4092,
	4093, 4093, 4094, 4094, 4094, 4095, 4094, 4094, 4094, 4093,
	4093, 4092, 4091, 4090, 4088, 4087, 4085, 4083, 4081, 4079,
	4077, 4075, 4072, 4070, 4067, 4064, 4061, 4057, 4054, 4050,
	4046, 4042, 4038, 4034, 4030, 4025, 4021, 4016, 4011, 4006,
	4000, 3995, 3989, 3984, 3978, 3972, 3966, 3959, 3953, 3946,
	3939, 3932, 3925, 3918, 3911, 3903, 3896, 3888, 3880, 3872,
	3864, 3855, 3847, 3838, 3829, 3820, 3811, 3802, 3792, 3783,
	3773, 3763, 3753, 3743, 3733, 3723, 3712, 3701, 3691, 3680,
	3668, 3657, 3646, 3634, 3623, 3611, 3599, 3587, 3575, 3563,
	3550, 3537, 3525, 3512, 3499, 3486, 3473, 3459, 3446, 3432,
	3418, 3404, 3390, 3376, 3362, 3348, 3333, 3318, 3304, 3289,
	3274, 3258, 3243, 3228, 3212, 3197, 3181, 3165, 3149, 3133,
	3117, 3100, 3084, 3067, 3051, 3034, 3017, 3000, 2983, 2965,
	2948, 2930, 2913, 2895, 2877, 2859, 2841, 2823, 2805, 2787,
	2768, 2750, 2731, 2712, 2693, 2674, 2655, 2636, 2617, 2597,
	2578, 2558, 2539, 2519, 2499, 2479, 2459, 2439, 2419, 2398,
	2378, 2357, 2337, 2316, 2295, 2275, 2254, 2233, 2212, 2190,
	2169, 2148, 2126, 2105, 2083, 2061, 2040, 2018, 1996, 1974,
	1952, 1930, 1908, 1885, 1863, 1841, 1818, 1796, 1773, 1750,
	1728, 1705, 1682, 1659, 1636, 1613, 1590, 1567, 1543, 1520,
	1497, 1473, 1450, 1426, 1403, 1379, 1355, 1332, 1308, 1284,
	1260, 1236, 1212, 1188, 1164, 1140, 1116, 1092, 1067, 1043, 
	1019, 995, 970, 946, 921, 897, 872, 848, 823, 798, 
	774, 749, 724, 700, 675, 650, 625, 600, 575, 551, 
	526, 501, 476, 451, 426, 401, 376, 351, 326, 301,
	276, 251, 226, 200, 175, 150, 125, 100, 75, 50, 
	25, 0, -25, -50, -75, -100, -125, -150, -175, -200, 
	-226, -251, -276, -301, -326, -351, -376, -401, -426, -451, 
	-476, -501, -526, -551, -575, -600, -625, -650, -675, -700, 
	-724, -749, -774, -798, -823, -848, -872, -897, -921, -946, 
	-970, -995, -1019, -1043, -1067, -1092, -1116, -1140, -1164, -1188,
	-1212, -1236, -1260, -1284, -1308, -1332, -1355, -1379, -1403, -1426,
	-1450, -1473, -1497, -1520, -1543, -1567, -1590, -1613, -1636, -1659,
	-1682, -1705, -1728, -1750, -1773, -1796, -1818, -1841, -1863, -1885,
	-1908, -1930, -1952, -1974, -1996, -2018, -2040, -2061, -2083, -2105,
	-2126, -2148, -2169, -2190, -2212, -2233, -2254, -2275, -2295, -2316,
	-2337, -2357, -2378, -2398, -2419, -2439, -2459, -2479, -2499, -2519,
	-2539, -2558, -2578, -2597, -2617, -2636, -2655, -2674, -2693, -2712,
	-2731, -2750, -2768, -2787, -2805, -2823, -2841, -2859, -2877, -2895,
	-2913, -2930, -2948, -2965, -2983, -3000, -3017, -3034, -3051, -3067,
	-3084, -3100, -3117, -3133, -3149, -3165, -3181, -3197, -3212, -3228,
	-3243, -3258, -3274, -3289, -3304, -3318, -3333, -3348, -3362, -3376,
	-3390, -3404, -3418, -3432, -3446, -3459, -3473, -3486, -3499, -3512,
	-3525, -3537, -3550, -3563, -3575, -3587, -3599, -3611, -3623, -3634,
	-3646, -3657, -3668, -3680, -3691, -3701, -3712, -3723, -3733, -3743,
	-3753, -3763, -3773, -3783, -3792, -3802, -3811, -3820, -3829, -3838,
	-3847, -3855, -3864, -3872, -3880, -3888, -3896, -3903, -3911, -3918,
	-3925, -3932, -3939, -3946, -3953, -3959, -3966, -3972, -3978, -3984,
	-3989, -3995, -4000, -4006, -4011, -4016, -4021, -4025, -4030, -4034,
	-4038, -4042, -4046, -4050, -4054, -4057, -4061, -4064, -4067, -4070,
	-4072, -4075, -4077, -4079, -4081, -4083, -4085, -4087, -4088, -4090,
	-4091, -4092, -4093, -4093, -4094, -4094, -4094, -4095, -4094, -4094,
	-4094, -4093, -4093, -4092, -4091, -4090, -4088, -4087, -4085, -4083,
	-4081, -4079, -4077, -4075, -4072, -4070, -4067, -4064, -4061, -4057,
	-4054, -4050, -4046, -4042, -4038, -4034, -4030, -4025, -4021, -4016,
	-4011, -4006, -4000, -3995, -3989, -3984, -3978, -3972, -3966, -3959,
	-3953, -3946, -3939, -3932, -3925, -3918, -3911, -3903, -3896, -3888,
	-3880, -3872, -3864, -3855, -3847, -3838, -3829, -3820, -3811, -3802,
	-3792, -3783, -3773, -3763, -3753, -3743, -3733, -3723, -3712, -3701,
	-3691, -3680, -3668, -3657, -3646, -3634, -3623, -3611, -3599, -3587,
	-3575, -3563, -3550, -3537, -3525, -3512, -3499, -3486, -3473, -3459,
	-3446, -3432, -3418, -3404, -3390, -3376, -3362, -3348, -3333, -3318,
	-3304, -3289, -3274, -3258, -3243, -3228, -3212, -3197, -3181, -3165,
	-3149, -3133, -3117, -3100, -3084, -3067, -3051, -3034, -3017, -3000,
	-2983, -2965, -2948, -2930, -2913, -2895, -2877, -2859, -2841, -2823,
	-2805, -2787, -2768, -2750, -2731, -2712, -2693, -2674, -2655, -2636,
	-2617, -2597, -2578, -2558, -2539, -2519, -2499, -2479, -2459, -2439,
	-2419, -2398, -2378, -2357, -2337, -2316, -2295, -2275, -2254, -2233,
	-2212, -2190, -2169, -2148, -2126, -2105, -2083, -2061, -2040, -2018,
	-1996, -1974, -1952, -1930, -1908, -1885, -1863, -1841, -1818, -1796,
	-1773, -1750, -1728, -1705, -1682, -1659, -1636, -1613, -1590, -1567,
	-1543, -1520, -1497, -1473, -1450, -1426, -1403, -1379, -1355, -1332,
	-1308, -1284, -1260, -1236, -1212, -1188, -1164, -1140, -1116, -1092,
	-1067, -1043, -1019, -995, -970, -946, -921, -897, -872, -848,
	-823, -798, -774, -749, -724, -700, -675, -650, -625, -600,
	-575, -551, -526, -501, -476, -451, -426, -401, -376, -351,
	-326, -301, -276, -251, -226, -200, -175, -150, -125, -100,
	-75, -50, -25
};

// rotation matrix
long m11, m12, m13, m21, m22, m23, m31, m32, m33;

/******************************************************************************/
int sinus(int angle) {
	return sintable[angle & 1023];
}
/******************************************************************************/
int cosinus(int angle) {
	return sintable[(angle + 256) & 1023];
}
/******************************************************************************/
void init_rotation(int alpha, int beta, int gamma) {

	int sa, ca, sb, cb, sg, cg;

	sa = sintable[alpha];
	ca = sintable[(alpha + 256) & 1023];
	sb = sintable[beta];
	cb = sintable[(beta + 256) & 1023];
	sg = sintable[gamma];
	cg = sintable[(gamma + 256) & 1023];

	m11 = (long)ca * cb;
	m11 = DIV4096(m11);

	m12 = (long)ca * sb;
	m12 = DIV4096(m12);
	m12 = m12 * sg - (long)sa * cg;
	m12 = DIV4096(m12);

	m13 = (long)ca * sb;
	m13 = DIV4096(m13);
	m13 = m13 * cg + (long)sa * sg;
	m13 = DIV4096(m13);

	m21 = (long)sa * cb;
	m21 = DIV4096(m21);

	m22 = (long)sa * sb;
	m22 = DIV4096(m22);
	m22 = m22 * sg + (long)ca * cg;
	m22 = DIV4096(m22);

	m23 = (long)sa * sb;
	m23 = DIV4096(m23);
	m23 = m23 * cg - (long)ca * sg;
	m23 = DIV4096(m23);

	m31 = - sb;

	m32 = (long)cb * sg;
	m32 = DIV4096(m32);

	m33 = (long)cb * cg;
	m33 = DIV4096(m33);
}
/******************************************************************************/
void rotate(struct vector *v) {
	long x, y, z;

	x = v->x * m11 + v->y * m12 + v->z * m13;
	y = v->x * m21 + v->y * m22 + v->z * m23;
	z = v->x * m31 + v->y * m32 + v->z * m33;

	v->x = DIV4096(x);
	v->y = DIV4096(y);
	v->z = DIV4096(z);
}
/******************************************************************************/
void vec2point(struct vector *v, struct point *p) {
	long x, y, z;

	x = v->x * m11 + v->y * m12 + v->z * m13;
	y = v->x * m21 + v->y * m22 + v->z * m23;
	z = v->x * m31 + v->y * m32 + v->z * m33;

	x = DIV4096(x);
	y = DIV4096(y);
	z = DIV4096(z);

	if (z >= -100) {
		p->x = (x << 6) / (z + 164) + 80;
		p->y = (y << 6) / (z + 164) + 50;
	} else {
		p->x = 0;
		p->y = 0;
    }
}
/******************************************************************************/
void setpoint(struct point *p) {
	register int x, y;
	x = p->x;
	y = p->y;
	if (x >= 0 && x <= 159 && y >= 0 && y <= 99)
    	setpixel(x, y);
}
/******************************************************************************/

